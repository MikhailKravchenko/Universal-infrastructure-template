---
- name: Install RKE2 on cluster nodes
  hosts: rke2
  become: true
  vars:
    rke2_channel: stable

  pre_tasks:
    - name: Ensure required packages are installed
      ansible.builtin.package:
        name:
          - curl
          - ca-certificates
        state: present

    - name: Disable swap (Kubernetes requirement)
      ansible.builtin.command: swapoff -a
      when: ansible_swaptotal_mb | default(0) | int > 0
      changed_when: false

    - name: Remove swap from fstab
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^(.*\sswap\s+sw\s+.*)$'
        replace: '# \1'
      notify: Reboot if required

  tasks:
    - name: Set primary node fact
      ansible.builtin.set_fact:
        is_primary: "{{ inventory_hostname == (groups['rke2'] | sort | first) }}"

    - name: Set primary node hostname fact (shared)
      ansible.builtin.set_fact:
        rke2_primary_host: "{{ groups['rke2'] | sort | first }}"
      run_once: true

    - name: Install RKE2 server on primary node
      ansible.builtin.shell: |
        curl -sfL https://get.rke2.io | \
          INSTALL_RKE2_TYPE=server \
          RKE2_CHANNEL={{ rke2_channel }} \
          RKE2_TOKEN={{ rke2_token }} \
          sh -
        systemctl enable rke2-server
        systemctl start rke2-server
      args:
        creates: /usr/local/bin/rke2
      when: is_primary | bool

    - name: Wait for RKE2 server to be ready on primary
      ansible.builtin.command: >
        /var/lib/rancher/rke2/bin/kubectl get nodes
      environment:
        KUBECONFIG: /etc/rancher/rke2/rke2.yaml
      register: rke2_kubectl_check
      retries: 20
      delay: 15
      until: rke2_kubectl_check.rc == 0
      when: is_primary | bool

    - name: Read RKE2 node token from primary
      ansible.builtin.slurp:
        src: /var/lib/rancher/rke2/server/node-token
      register: rke2_node_token_raw
      when: is_primary | bool

    - name: Set RKE2 join token fact
      ansible.builtin.set_fact:
        rke2_join_token: "{{ rke2_node_token_raw.content | b64decode | trim }}"
      when: is_primary | bool

    - name: Ensure RKE2 agent config directory exists
      ansible.builtin.file:
        path: /etc/rancher/rke2
        state: directory
        mode: "0755"
      when: not is_primary | bool

    - name: Configure RKE2 agent
      ansible.builtin.copy:
        dest: /etc/rancher/rke2/config.yaml
        mode: "0600"
        content: |
          server: https://{{ hostvars[rke2_primary_host].ansible_default_ipv4.address }}:9345
          token: {{ hostvars[rke2_primary_host].rke2_join_token }}
      when: not is_primary | bool

    - name: Install RKE2 agent
      ansible.builtin.shell: |
        curl -sfL https://get.rke2.io | \
          INSTALL_RKE2_TYPE=agent \
          RKE2_CHANNEL={{ rke2_channel }} \
          sh -
        systemctl enable rke2-agent
        systemctl start rke2-agent
      args:
        creates: /usr/local/bin/rke2-agent
      when: not is_primary | bool

    - name: Wait for kubeconfig to exist on primary
      ansible.builtin.wait_for:
        path: /etc/rancher/rke2/rke2.yaml
      when: is_primary | bool

    - name: Read RKE2 kubeconfig from primary
      ansible.builtin.slurp:
        src: /etc/rancher/rke2/rke2.yaml
      register: rke2_kubeconfig_raw
      when: is_primary | bool

    - name: Show original kubeconfig server line (debug)
      ansible.builtin.debug:
        msg: >
          ORIGINAL_SERVER_LINE={{ (rke2_kubeconfig_raw.content
            | b64decode
            | regex_search('server:.*https://[0-9\\.]+:6443')
          ) | default('NOT_FOUND') }}
      when: is_primary | bool

    - name: Show primary node internal IP (debug)
      ansible.builtin.debug:
        msg: "PRIMARY_INTERNAL_IP={{ ansible_default_ipv4.address }}"
      when: is_primary | bool

    - name: Replace localhost with primary internal IP in kubeconfig
      ansible.builtin.set_fact:
        rke2_kubeconfig_content: >-
          {{ (rke2_kubeconfig_raw.content
              | b64decode
              | replace(
                  'https://127.0.0.1:6443',
                  'https://' ~ ansible_default_ipv4.address ~ ':6443'
                )
            )
          }}
      when: is_primary | bool

    - name: Show patched kubeconfig server line (debug)
      ansible.builtin.debug:
        msg: >
          PATCHED_SERVER_LINE={{ (rke2_kubeconfig_content
            | regex_search('server:.*https://[0-9\\.]+:6443')
          ) | default('NOT_FOUND') }}
      when: is_primary | bool

    - name: Write kubeconfig to bastion (localhost)
      ansible.builtin.copy:
        dest: "{{ playbook_dir }}/kubeconfig/rke2.yaml"
        content: "{{ rke2_kubeconfig_content }}"
        mode: "0600"
      delegate_to: localhost
      become: false
      run_once: true
      when: is_primary | bool

    - name: Ensure Argo CD namespace exists
      ansible.builtin.command: >
        /var/lib/rancher/rke2/bin/kubectl create namespace argocd
      register: argocd_ns
      failed_when: argocd_ns.rc != 0 and 'AlreadyExists' not in argocd_ns.stderr
      environment:
        KUBECONFIG: /etc/rancher/rke2/rke2.yaml
      when: is_primary | bool

    - name: Install Argo CD into cluster
      ansible.builtin.command: >
        /var/lib/rancher/rke2/bin/kubectl apply -n argocd
        -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      environment:
        KUBECONFIG: /etc/rancher/rke2/rke2.yaml
      when: is_primary | bool

    - name: Wait for Argo CD server to be ready
      ansible.builtin.command: >
        /var/lib/rancher/rke2/bin/kubectl rollout status deploy/argocd-server -n argocd --timeout=300s
      environment:
        KUBECONFIG: /etc/rancher/rke2/rke2.yaml
      when: is_primary | bool

    - name: Copy ingress-nginx NodePort manifest to primary node
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../kubernetes/ingress-nginx-nodeport.yaml"
        dest: /tmp/ingress-nginx-nodeport.yaml
        mode: "0644"
      when: is_primary | bool

    - name: Expose ingress-nginx via NodePort for Load Balancer
      ansible.builtin.command: >
        /var/lib/rancher/rke2/bin/kubectl apply -f /tmp/ingress-nginx-nodeport.yaml
      environment:
        KUBECONFIG: /etc/rancher/rke2/rke2.yaml
      when: is_primary | bool

    - name: Copy Argo CD NodePort manifest to primary node
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../kubernetes/argocd-nodeport.yaml"
        dest: /tmp/argocd-nodeport.yaml
        mode: "0644"
      when: is_primary | bool

    - name: Expose Argo CD via NodePort for Load Balancer
      ansible.builtin.command: >
        /var/lib/rancher/rke2/bin/kubectl apply -f /tmp/argocd-nodeport.yaml
      environment:
        KUBECONFIG: /etc/rancher/rke2/rke2.yaml
      when: is_primary | bool

  handlers:
    - name: Reboot if required
      ansible.builtin.reboot:
        msg: "Rebooting to apply swap changes"
        reboot_timeout: 600
