stages:
  - validate
  - release
  - deploy

# Проверка Helm-чартов перед публикацией: dependency update, lint, template
lint-helm:
  stage: validate
  image: alpine/helm:latest
  only:
    changes:
      - "app-chart/**/*"
      - "monitoring-chart/**/*"
      - "data-services-chart/**/*"
      - "external-secrets-chart/**/*"
  script:
    - |
      lint_chart() {
        echo "=== Lint $1 ==="
        cd "$1"
        if [ -f Chart.yaml ]; then
          helm dependency update 2>/dev/null || true
          helm lint .
          helm template test . --namespace test > /dev/null
        fi
        cd -
      }
    - lint_chart app-chart
    - helm repo add bitnami https://charts.bitnami.com/bitnami
    - lint_chart monitoring-chart
    - lint_chart data-services-chart
    - lint_chart external-secrets-chart

release-helm:
  stage: release
  image: alpine/helm:latest
  only:
    changes:
      - "app-chart/**/*"
  script:
    - cd app-chart
    - helm dependency update
    - helm package . --version "0.1.3-pipeline${CI_PIPELINE_ID}"
    - curl -L -u $HELM_REPO_USERNAME:$HELM_REPO_PASSWORD $NEXUS_HELM_REPO --upload-file app-*.tgz

release-monitoring-helm:
  stage: release
  image: alpine/helm:latest
  only:
    changes:
      - "monitoring-chart/**/*"
  script:
    - cd monitoring-chart
    - helm dependency update
    - helm package . --version "0.1.0-pipeline${CI_PIPELINE_ID}"
    - curl -L -u $HELM_REPO_USERNAME:$HELM_REPO_PASSWORD $NEXUS_HELM_MONITORING_REPO --upload-file monitoring-*.tgz

# Публикация чарта data-services (PostgreSQL, Redis, RabbitMQ, Kafka). Переменная NEXUS_HELM_DATA_SERVICES_REPO — URL репозитория в Nexus.
release-data-services-helm:
  stage: release
  image: alpine/helm:latest
  only:
    changes:
      - "data-services-chart/**/*"
  script:
    - helm repo add bitnami https://charts.bitnami.com/bitnami
    - cd data-services-chart
    - helm dependency update
    - helm package . --version "0.1.0-pipeline${CI_PIPELINE_ID}"
    - curl -L -u $HELM_REPO_USERNAME:$HELM_REPO_PASSWORD ${NEXUS_HELM_DATA_SERVICES_REPO:-$NEXUS_HELM_REPO} --upload-file data-services-*.tgz

# Публикация чарта конфигурации External Secrets (SecretStore, ExternalSecret для Lockbox)
release-external-secrets-helm:
  stage: release
  image: alpine/helm:latest
  only:
    changes:
      - "external-secrets-chart/**/*"
  script:
    - cd external-secrets-chart
    - helm package . --version "0.1.0-pipeline${CI_PIPELINE_ID}"
    - curl -L -u $HELM_REPO_USERNAME:$HELM_REPO_PASSWORD ${NEXUS_HELM_EXTERNAL_SECRETS_REPO:-$NEXUS_HELM_REPO} --upload-file external-secrets-config-*.tgz
